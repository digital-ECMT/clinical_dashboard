---
title: "Clinical dashboard"
author: "dECMT"
date: "`r Sys.Date()`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
runtime: shiny
---

```{r setup, include=FALSE}
require(flexdashboard)
require(dplyr)
require(tidyr)
require(kableExtra)
require(stringr)
#require(DT)
#require(kableExtra)
#require(cgdsr)
#require(formattable)
require(ggplot2)
require(reshape2)
require(survival)
#require(survminer)
require(ggfortify)
require(gganimate)
require(av)
require(shinyWidgets)
require(lubridate)


## clean up
rm(list=ls())

##create a custom palette based on palette used for dECMT slide template
dECMTpalette <- c(rgb(red=0, green=137, blue=174, maxColorValue = 255), 
                  rgb(red=208, green=134, blue=146, maxColorValue = 255),
                  rgb(red=237, green=154, blue=75, maxColorValue = 255),
                  rgb(red=174, green=190, blue=6, maxColorValue = 255),
                  rgb(red=0, green=105, blue=145, maxColorValue = 255), 
                  rgb(red=197, green=74, blue=117, maxColorValue = 255),
                  rgb(red=229, green=113, blue=67, maxColorValue = 255),
                  rgb(red=119, green=167, blue=40, maxColorValue = 255),
                  rgb(red=113, green=121, blue=126, maxColorValue = 255),
                  rgb(red=0, green=0, blue=0, maxColorValue = 255),
                  rgb(red=242, green=222, blue=3, maxColorValue = 255),
                  rgb(red=146, green=68, blue=168, maxColorValue = 255),
                  rgb(red=108, green=200, blue=93, maxColorValue = 255),
                  rgb(red=254, green=240, blue=0, maxColorValue = 255),
                  rgb(red=105, green=25, blue=122, maxColorValue = 255),
                  rgb(red=35, green=99, blue=32, maxColorValue = 255))


```
  
  
```{r read and process demographics, warning=FALSE}
demographics <- read.csv(file = paste0(getwd(), "/DEMOGRAPHICS.csv"), stringsAsFactors = FALSE, header = TRUE)

## drop any rows with missing values
demographics <- demographics[complete.cases(demographics), ]

## drop any redundant rows
demographics <- unique(demographics)

## detect variable type... 
demographics$VARIABLE_TYPE <- NA
## first try and convert to numeric (anything other than number gives NA)
demographics$VARIABLE_TYPE[!is.na(as.numeric(demographics$VARIABLE_VALUE))] <- "NUMERIC"
## try and parse to date  
demographics$VARIABLE_TYPE[!is.na(lubridate::ymd(demographics$VARIABLE_VALUE))] <- "DATE"
## try and convert to logical
demographics$VARIABLE_TYPE[!is.na(as.logical(demographics$VARIABLE_VALUE))] <- "LOGICAL"
## if none of the above, assume character
demographics$VARIABLE_TYPE[is.na(demographics$VARIABLE_TYPE)] <- "CHARACTER"



## cast to wide format 
demographics_wide <- reshape2::dcast(data = demographics, formula = SUBJECT_ID ~ VARIABLE_NAME, value.var = "VARIABLE_VALUE")
demographics_wide$DOB <- lubridate::ymd(demographics_wide$DOB)

## loop through each column in demographics wide table and format according to corresponding VARIABLE_TYPE value... 
for(i in 2:ncol(demographics_wide)) {
  column_name = names(demographics_wide)[i]
  column_type = unique(demographics$VARIABLE_TYPE[demographics$VARIABLE_NAME == column_name])

  if(column_type == "DATE") {
    demographics_wide[ , i] <- lubridate::ymd(demographics_wide[ , i])
    next
  }
  if(column_type == "NUMERIC") {
    demographics_wide[ , i] <- as.numeric(demographics_wide[ , i])
    next
  }
  
  else {demographics_wide[ , i] <- factor(demographics_wide[ , i])
    next}
}


```
   
   
   
<!-- Inputs {.sidebar} -->
<!-- ----------------------------------------------------------------------- -->

<!-- **POPULATION FILTERS**   -->
<!-- (selected filters will be applied to all charts).   -->


<!-- ```{r specify sidebar filters} -->

<!-- demographic_variables <- unique(demographics$VARIABLE_NAME) -->

<!-- selectInput(inputId = "demographic_vars", label="Demographics:", choices = demographic_variables, selected = NULL, multiple = TRUE,  selectize = TRUE, width = NULL, size = NULL) -->



<!-- # fluidRow(selectInput(inputId = "demographic_vars", label="Demographics:", choices = demographic_variables, selected = NULL, multiple = TRUE,  selectize = TRUE, width = NULL, size = NULL),  -->
<!-- #          selectInput(inputId = "demographic_vars", label="Demographics:", choices = demographic_variables, selected = NULL, multiple = TRUE,  selectize = TRUE, width = NULL, size = NULL)) -->

<!-- fluidRow(column(6,selectInput("COLUMN", "Filter By:", choices = demographic_variables)), -->
<!--                  column(6,selectInput("COLUMN", "Include:", choices = demographic_variables) -->
<!--                         ) -->
<!-- ) -->
<!-- ```   -->
  
Row {.tabset}
-----------------------------------------------------------------------  
   
### Population  
  
```{r reactive demographics table}

## render table with filters
DT::renderDT(demographics_wide,
                                 filter = "top"
        )


```

   
   
   
   
   
   
   